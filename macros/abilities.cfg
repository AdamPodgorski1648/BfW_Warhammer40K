#define ABILITY_INSPIRE_LEVEL1
[leadership]
    id=inspire1
    value=15
    cumulative=no
    name= _ "inspires 1"
    description=_"This unit can inspire friendly units that are next to it, making them fight better.   
    Adjacent friendly level 0 units will do 30% more damage in battle.
    Adjacent friendly level 1 units will do 15% more damage in battle."
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=1
        [/filter]
    [/affect_adjacent]
[/leadership]
[leadership]
    id=inspire1
    value=30
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=0
        [/filter]
    [/affect_adjacent]
[/leadership]
#enddef

#define ABILITY_INSPIRE_LEVEL2
[leadership]
    id=inspire2
    value=15
    cumulative=no
    name= _ "inspires 2"
    description=_"This unit can inspire friendly units that are next to it, making them fight better.
    Adjacent friendly level 0 units will do 45% more damage in battle.
    Adjacent friendly level 1 units will do 30% more damage in battle.
    Adjacent friendly level 2 units will do 15% more damage in battle."
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=2
        [/filter]
    [/affect_adjacent]
[/leadership]
[leadership]
    id=inspire2
    value=30
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=1
        [/filter]
    [/affect_adjacent]
[/leadership]
[leadership]
    id=inspire2
    value=45
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=0
        [/filter]
    [/affect_adjacent]
[/leadership]
#enddef

#define ABILITY_INSPIRE_LEVEL3
[leadership]
    id=inspire3
    value=15
    cumulative=no
    name= _ "inspires 3"
    description=_"This unit can inspire friendly units that are next to it, making them fight better.   
    Adjacent friendly level 0 units will do 60% more damage in battle.
    Adjacent friendly level 1 units will do 45% more damage in battle.
    Adjacent friendly level 2 units will do 30% more damage in battle.
    Adjacent friendly level 3 units will do 15% more damage in battle."
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=3
        [/filter]
    [/affect_adjacent]
[/leadership]
[leadership]
    id=inspire3
    value=30
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=2
        [/filter]
    [/affect_adjacent]
[/leadership]

[leadership]
    id=inspire3
    value=45
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=1
        [/filter]
    [/affect_adjacent]
[/leadership]
[leadership]
    id=inspire3
    value=60
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=0
        [/filter]
    [/affect_adjacent]
[/leadership]
#enddef

#define ABILITY_INSPIRE_LEVEL4
[leadership]
    id=inspire4
    value=15
    cumulative=no
    name= _ "inspires 4"
    description=_"This unit can inspire friendly units that are next to it, making them fight better.    
    Adjacent friendly level 0 units will do 75% more damage in battle.
    Adjacent friendly level 1 units will do 60% more damage in battle.
    Adjacent friendly level 2 units will do 45% more damage in battle.
    Adjacent friendly level 3 units will do 30% more damage in battle.
    Adjacent friendly level 4 units will do 15% more damage in battle."
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=4
        [/filter]
    [/affect_adjacent]
[/leadership]
[leadership]
    id=inspire4
    value=30
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=3
        [/filter]
    [/affect_adjacent]
[/leadership]

[leadership]
    id=inspire4
    value=45
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=2
        [/filter]
    [/affect_adjacent]
[/leadership]

[leadership]
    id=inspire4
    value=60
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=1
        [/filter]
    [/affect_adjacent]
[/leadership]
[leadership]
    id=inspire4
    value=75
    cumulative=no
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
        [filter]
            level=0
        [/filter]
    [/affect_adjacent]
[/leadership]
#enddef

#define ABILITY_TERROR
[leadership]
    id=terror
    value="(-(15 * (level - other.level) + 15))"
    cumulative=no
    name= _ "terror"
    description= _ "This unit can frighten enemy units that are next to it, making them fight worse.
    Adjacent enemy units of lower level will do less damage in battle. When an enemy unit of lower level is adjacent and engages in combat, its attacks do 15% less damage times the difference in their levels + 15%."
    affect_self=no
    affect_allies=no
    affect_enemies=yes
    [affect_adjacent]
        [filter]
            formula="level <= other.level"
        [/filter]
    [/affect_adjacent]
[/leadership]
#enddef




#define ABILITY_DISENGAGE VALUE
[dummy]
    id=disengage{VALUE}
    name= _ "disengage"+" "+"+"+{VALUE}
    description=_"This unit gains additional moves back after attacking, but cannot attack again."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=attack_end
id=disengage_event{VALUE}
first_time_only=no
[filter]
    x,y=$x1,$y1
    ability=disengage{VALUE}
[/filter]
{VARIABLE_OP unit.moves add {VALUE}}
[unstore_unit]
    variable=unit
    {COLOR_HEAL}
    text="+"+{VALUE}+" "+_"movepoints"
    find_vacant=no
[/unstore_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_DIVINE_GUIDANCE VALUE
# wmlxgettext: [abilities]
[dummy]
    id=divine_guidance
    name= _ "guidance"
    special_note=
    description=_"This unit gives each adjacent allied unit +1 to experience earned in battle."
[/dummy]
[/abilities]
[event]
name=attack_end
id=divine_guidance1
[filter]
    [filter_adjacent]
        ability=divine_guidance
        is_enemy=false
    [/filter_adjacent]
[/filter]
[set_variable]
    name=unit.experience
    add={VALUE}
[/set_variable]
[unstore_unit]
    variable=unit
    text=_ " " + {VALUE} + " "
    red,green,blue=0,200,255
[/unstore_unit]
first_time_only=no
[/event]

[event]
name=attack_end
id=divine_guidance2
[filter_second]
    [filter_adjacent]
        ability=divine_guidance
        is_enemy=false
    [/filter_adjacent]
[/filter_second]
[set_variable]
    name=second_unit.experience
    add={VALUE}
[/set_variable]
[unstore_unit]
    variable=second_unit
    text=_ " " + {VALUE} + " "
    red,green,blue=0,200,255
[/unstore_unit]
first_time_only=no
[/event]
[+abilities]
# wmlxgettext: [/abilities]
#enddef

#define ABILITY_EMPEROR_PROTECTS
[dummy]
    id=emperor_protects
    name= _ "Emperor protects"
    description=_"If a friendly adjacent unit with more than one hitpoint dies, it is resurrected. If it dies again (having one hitpoint), it will be killed."
[/dummy] # wmlxgettext: [abilities]
[/abilities]

[event]
name=attack
first_time_only=no
id=protect_event1

[store_unit]
    [filter]
        [and]
            id=$unit.id
            [or]
                id=$second_unit.id
            [/or]
        [/and]
        [filter_adjacent]
            is_enemy=no
            ability=emperor_protects
        [/filter_adjacent]
        formula="hitpoints > 1"
        [not]
            status=not_living
        [/not]
    [/filter]
    variable=protect_candidates
[/store_unit]
[/event]

[event]
name=die
first_time_only=no
id=protect_event2
[filter]
    find_in=protect_candidates
[/filter]

{VARIABLE unit.hitpoints 1}
{VARIABLE_OP unit.experience add 1}
{VARIABLE_OP second_unit.experience sub 5}

[if]
    [variable]
        name=second_unit.experience
        less_than=0
    [/variable]
    [then]
        {VARIABLE second_unit.experience 0}
    [/then]
[/if]
[unstore_unit]
    variable=unit
    find_vacant=no
    text= _ "The Emperor Protects"
    red,green,blue=255,252,187
[/unstore_unit]

[sound]
    name={SOUND_LIST:HOLY}
[/sound]

[unstore_unit]
    variable=second_unit
    find_vacant=no
[/unstore_unit]
{CLEAR_VARIABLE protect_candidates}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_ZEAL
[resistance]
    id=zeal
    divide=2
    max_value=50
    [filter_base_value]
        greater_than=-100
        less_than=0
    [/filter_base_value]
    name= _ "zeal"
    description= _ "This units vulnerabilities are halved when attacking."
    affect_self=yes
    active_on=offense
[/resistance]
#enddef

#define ABILITY_PROTECTION
[resistance]
    id=protection
    add=20
    max_value=50
    apply_to=blade,pierce,impact,fire,cold,arcane
    name= _ "aura of protection"
    description=_"Adjacent friendly units receive a +20% bonus to all resistances (up to a maximum of 50%)."
    affect_self=no
    affect_allies=yes
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
    [/affect_adjacent]
    [filter_base_value]
        less_than=50
    [/filter_base_value]
[/resistance]
#enddef

#define ABILITY_INQUISITOR'S_MIGHT
[resistance]
    id=inquisitor's might
    sub=20
    max_value=80
    apply_to=pierce,blade,impact,arcane
    name= _ "inquisitor's might"
    description=_"All adjacent enemy unitsâ€™ pierce, blade, impact and arcane resistances are weakened by 20%."
    affect_self=no
    affect_allies=no
    affect_enemies=yes
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
    [/affect_adjacent]
[/resistance]
#enddef

#define ABILITY_UNWAVERING_FAITH VALUE
[dummy]
    id=unwavering_faith{VALUE}
    name= _ "martyrdom"+" +"+{VALUE}
    description=_"This ardent sister gains some hitpoints added to her current health whenever an adjacent sisters of battle unit dies. The amount of hitpoints gained:"+" +"+{VALUE}
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=die
id=unwavering_faith_event_{VALUE}
first_time_only=no
[filter]
    [filter_adjacent]
        ability=unwavering_faith{VALUE}
        is_enemy=false
    [/filter_adjacent]
    race=Sisters
[/filter]

[delay]
    time=10
[/delay]
[heal_unit]
    [filter]
        ability=unwavering_faith{VALUE}
        side=$unit.side
        [filter_adjacent]
            id=$unit.id
        [/filter_adjacent]
    [/filter]
    amount={VALUE}
    animate=yes
    restore_statuses=no
[/heal_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_DAUNTLESS
[resistance]
    id=dauntless
    multiply=2
    max_value=50
    [filter_base_value]
        greater_than=0
        less_than=50
    [/filter_base_value]
    name= _ "dauntless"
    female_name= _ "female^dauntless"
    description= _ "While attacking, this unit's resistances are doubled, up to a maximum of 50. Weaknesses are not affected."
    affect_self=yes
    active_on=offense
[/resistance]
#enddef

#define ABILITY_INDOMITABLE
[resistance]
    id=indomitable
    add=30
    max_value=60
    apply_to=blade,pierce,impact,fire,cold,arcane
    name= _ "indomitable"
    female_name= _ "female^indomitable"
    description= _ "While defending, this unit receives a +30% bonus to all resistances (up to a maximum of 60%)."
    affect_self=yes
    active_on=defense
[/resistance]
#enddef

#define ABILITY_LIGHT_OF_THE_EMPEROR

#arg HALO
""#endarg
[illuminates]
    id=illumination
    value=50
    max_value=50
    cumulative=no
    name= _ "light of the Emperor"
    female_name= _ "female^light of the Emperor"
    description= _ "This unit illuminates the surrounding area, making lawful units fight better, and chaotic units fight worse.
    
    Any units adjacent to this unit will fight as if enlightened by the Emperor himself."
    special_note={INTERNAL:SPECIAL_NOTES_ILLUMINATES}
    affect_self=yes
    halo_image={HALO}
[/illuminates]
#enddef

#define ABILITY_40K_POISON_AURA
[dummy]
    id=poisonousaura
    name= _ "poisonous aura"
    description=_"All living enemy units adjacent to this unit lose 1 HP and become poisoned at the beginning of this unit's turn. If an enemy unit's HP goes to or below 0 HP, its HP are set to 1."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=turn refresh
id=poisonousaura
first_time_only=no

[store_unit]
    [filter]
        [and]
            type=nurglespawn
            side=$side_number
            [or]
                type=nurglespawnlvl3
                side=$side_number
            [/or]
        [/and]
    [/filter]
    variable=com
[/store_unit]

[foreach]
    array=com
    [do]
        [harm_unit]
            [filter]
                [filter_adjacent]
                    id=$this_item.id
                    is_enemy=yes
                [/filter_adjacent]
                [not]
                    [filter_wml]
                        [status]
                            petrified=yes
                        [/status]
                    [/filter_wml]
                [/not]
                [not]
                    status=unpoisonable
                [/not]
            [/filter]
            amount=1
            fire_event=yes
            animate=no
            kill=no
            poisoned=yes
        [/harm_unit]
    [/do]
[/foreach]

{CLEAR_VARIABLE com}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_POISON_AURA2
[dummy]
    id=poisonousaura2
    name= _ "bad stuff"
    description=_"All living enemy units adjacent to this unit lose 1 HP and become poisoned at the beginning of this unit's turn. If an enemy unit's HP goes to or below 0 HP, its HP are set to 1."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=turn refresh
id=poisonousaura2
first_time_only=no

[store_unit]
    [filter]
        [and]
            type=maddok
            side=$side_number
            [or]
                type=maddoklvl3
                side=$side_number
            [/or]
        [/and]
    [/filter]
    variable=com
[/store_unit]

[foreach]
    array=com
    [do]
        [harm_unit]
            [filter]
                [filter_adjacent]
                    id=$this_item.id
                    is_enemy=yes
                [/filter_adjacent]
                [not]
                    [filter_wml]
                        [status]
                            petrified=yes
                        [/status]
                    [/filter_wml]
                [/not]
                [not]
                    status=unpoisonable
                [/not]
            [/filter]
            amount=1
            fire_event=yes
            animate=no
            kill=no
            poisoned=yes
        [/harm_unit]
    [/do]
[/foreach]

{CLEAR_VARIABLE com}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_DETERIORATE TYPE
[dummy]
    id=deteriorate
    name= _ "unbending will"
    description=_"When dying this unit's unbending will lives on."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=die
id=deteriorate_event
first_time_only=no
[filter]
    ability=deteriorate
[/filter]
[unit]
    type={TYPE}
    side=$unit.side
    x,y=$x1,$y1
    moves=0
    animate=no
[/unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_DETERIORATE2 TYPE
[dummy]
    id=deteriorate_a
    name= _ "deteriorate"
    description=_"When dying this unit deteriorates into a weaker unit."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=die
id=deteriorate_a_event
first_time_only=no
[filter]
    ability=deteriorate_a
[/filter]
[unit]
    type={TYPE}
    side=$unit.side
    x,y=$x1,$y1
    moves=0
    animate=no
[/unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef


#define ABILITY_40K_REGENERATE VALUE
[regenerate]
    value={VALUE}
    id=40k_regenerates{VALUE}
    name=_"regenerates"+" +"+{VALUE}
    description= _ "The unit will heal itself some HP per turn. If it is poisoned, it will remove the poison instead of healing. The amount of hitpoints restored:"+" +"+{VALUE}
    affect_self=yes
    poison=cured
[/regenerate]
#enddef

#define ABILITY_40K_BLOOD_FUELED
[dummy]
    id=bloodfueled
    name= _ "bloodfueled"
    description=_ "This unit gains 1 HP after an adjacent living unit is harmed."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=attacker hits
id=bloodfueled_event1
first_time_only=no

[filter]
[/filter]
[filter_second]
    [filter_adjacent]
        ability=bloodfueled
    [/filter_adjacent]
    [not]
        [filter_wml]
            [status]
                not_living="yes"
            [/status]
        [/filter_wml]
    [/not]
[/filter_second]

[delay]
    time=100
[/delay]
[heal_unit]
    [filter]
        ability=bloodfueled
        [filter_adjacent]
            id=$second_unit.id
        [/filter_adjacent]
    [/filter]
    amount=1
    animate=yes
    restore_statuses=no
[/heal_unit]
[/event]
[event]
name=defender hits
id=bloodfueled_event2
first_time_only=no

[filter]
    [filter_adjacent]
        ability=bloodfueled
    [/filter_adjacent]
    [not]
        [filter_wml]
            [status]
                not_living="yes"
            [/status]
        [/filter_wml]
    [/not]
[/filter]
[filter_second]
[/filter_second]

[delay]
    time=100
[/delay]
[heal_unit]
    [filter]
        ability=bloodfueled
        [filter_adjacent]
            id=$unit.id
        [/filter_adjacent]
    [/filter]
    amount=1
    animate=yes
    restore_statuses=no
[/heal_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_PHASE
[dummy]
    id=phase
    name= _ "phase shift"
    description=_ "This unit both takes and deals half the physical damage for one turn after getting hit by an attacker."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=attacker hits
first_time_only=no
id=phase_event1

[filter_second]
    [and]
        [not]
            ability=phased
        [/not]
    [/and]
    ability=phase
[/filter_second]

[set_variables]
    name=phase_unit_information
    mode=append
    [value]
        id=$second_unit.id
        side=$second_unit.side
        turn_of_unphase=$"($turn_number| + 1)"
    [/value]
[/set_variables]
{MODIFY_UNIT id=$second_unit.id status.phase yes}

[floating_text]
    x,y=$x2,$y2
    text="<span color='#00008b'>" + _ "phase shift" + "</span>"
[/floating_text]

[object]
    silent=yes
    [filter]
        x,y=$x2,$y2
    [/filter]
	[effect]
		apply_to=image_mod
        replace="O(0.5)"
    [/effect]
    [effect]
        apply_to=new_ability
        [abilities]
            [leadership]
                id=phased
                name=_"phased"
                value=-50
                cumulative=yes
                affect_self=yes
            [/leadership]
        [/abilities]
    [/effect]
    [effect]
        apply_to=new_ability
        [abilities]
            [resistance]
                id=phased2
                name=_"phased"
                add=30
                max_value=100
                apply_to=blade,pierce,impact
                cumulative=yes
                affect_self=yes
            [/resistance]
        [/abilities]
    [/effect]
[/object]
[/event]

[event]
name=side turn
id=phase_event2
first_time_only=no

[foreach]
    array=phase_unit_information
    [do]
        [if]
            [variable]
                name=this_item.turn_of_unphase
                less_than_equal_to=$turn_number
            [/variable]
            [and]
                [variable]
                    name=this_item.side
                    equals=$side_number
                [/variable]
            [/and]
            
            [then]
                [object]
                    silent=yes
                    [filter]
                        find_in=this_item
                    [/filter]
					
					[effect]
						apply_to=image_mod
						replace="NOP()"
					[/effect]
                    
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [leadership]
                                id=phased
                                name=_"phased"
                                cumulative=yes
                                affect_self=yes
                            [/leadership]
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [resistance]
                                id=phased2
                                name=_"phased"
                                add=30
                                max_value=100
                                apply_to=blade,pierce,impact
                                cumulative=yes
                                affect_self=yes
                            [/resistance]
                        [/abilities]
                    [/effect]
                [/object]
                {MODIFY_UNIT id=$this_item.id status.phase no}
                
                [clear_variable]
                    name=this_item
                [/clear_variable]
            [/then]
        [/if]
    [/do]
[/foreach]
[/event]

[event]
name=victory
id=phase_event3
first_time_only=no

[foreach]
    array=phase_unit_information
    [do]
        [object]
            silent=yes
            [filter]
                find_in=this_item
            [/filter]
			[effect]
				apply_to=image_mod
				replace="NOP()"
			[/effect]
            [effect]
                apply_to=remove_ability
                [abilities]
                    [leadership]
                        id=phased
                        name=_"phased"
                        value=-50
                        cumulative=yes
                        affect_self=yes
                    [/leadership]
                [/abilities]
            [/effect]
            [effect]
                apply_to=remove_ability
                [abilities]
                    [resistance]
                        id=phased2
                        name=_"phased"
                        add=30
                        max_value=100
                        apply_to=blade,pierce,impact
                        cumulative=yes
                        affect_self=yes
                    [/resistance]
                [/abilities]
            [/effect]
        [/object]
        {MODIFY_UNIT id=$this_item.side.id status.phase no}
        
        [clear_variable]
            name=this_item
        [/clear_variable]
    [/do]
[/foreach]

{CLEAR_VARIABLE phase_unit_information}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef



#define ABILITY_40K_CHRONOAURA
[dummy]
    id=chronoaura
    name= _ "chronometron"
    description=_" All adjacent friendly units receive +10% chance to hit and all adjacent enemy units receive -10% chance to hit."
[/dummy]
[chance_to_hit]
    id=chronoaura_debuff
    sub=10
    cumulative=yes
    affect_self=no
    affect_allies=no
    affect_enemies=yes
    [affect_adjacent]
        [filter]
        [/filter]
    [/affect_adjacent]
[/chance_to_hit]
[chance_to_hit]
    id=chronoaura_buff
    add=10
    cumulative=yes
    affect_self=yes
    affect_allies=yes
    affect_enemies=no
    [affect_adjacent]
        [filter]
        [/filter]
    [/affect_adjacent]
[/chance_to_hit]	# wmlxgettext: [abilities]
[/abilities]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_SOLAR_PULSE
[dummy]
    id=solar_pulse
    name= _ "solar pulse"
    description=_"All enemy units adjacent to this unit lose 6 HP at the start of the units turn. This cannot kill."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=turn refresh
id=solar_pulse_event
first_time_only=no

[store_unit]
    [filter]
        [and]
            type=plasmancer
            side=$side_number
            [or]
                type=voidmancer
                side=$side_number
            [/or]
        [/and]
    [/filter]
    variable=comm
[/store_unit]

[foreach]
    array=comm
    [do]
        [harm_unit]
            [filter]
                [filter_adjacent]
                    id=$this_item.id
                    is_enemy=yes
                [/filter_adjacent]
                [not]
                    [filter_wml]
                        [status]
                            petrified=yes
                        [/status]
                    [/filter_wml]
                [/not]
            [/filter]
            amount=6
            fire_event=yes
            animate=no
            kill=no
        [/harm_unit]
    [/do]
[/foreach]

{CLEAR_VARIABLE comm}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_REANIMATION_PROTOCOL
[dummy]
    id=reanimation_protocol
    name= _ "reanimation protocol"
    description=_ "This unit gains one experience point each turn."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
name=turn refresh
id=reanimation_event1
first_time_only=no

[filter_condition]
    [have_unit]
        ability=reanimation_protocol
    [/have_unit]
[/filter_condition]

[store_unit]
    variable=reanimation
    [filter]
        ability=reanimation_protocol
        side=$side_number
    [/filter]
[/store_unit]

[foreach]
    array=reanimation
    
    [do]
        {VARIABLE_OP reanimation[$i].experience add 1}
        [unstore_unit]
            variable=reanimation[$i]
            find_vacant=no
            text="+1 XP"
            red,green,blue=50,50,200
        [/unstore_unit]
        
    [/do]
    
[/foreach]

{CLEAR_VARIABLE reanimation}

[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef


#define ABILITY_40K_ABSORB
[dummy]
    id=absorb
    name= _ "pain thirst"
    description= _ "When this unit is hit, it heals 1 HP."
[/dummy]# wmlxgettext: [abilities]
[/abilities]

[event]
name=attacker hits
id=absorb_event1
first_time_only=no

[filter]
[/filter]
[filter_second]
    ability=absorb
[/filter_second]

[delay]
    time=10
[/delay]
[if]
    [variable]
        name=second_unit.hitpoints
        greater_than=0
    [/variable]
    [then]
        [heal_unit]
            [filter]
                ability=absorb
            [/filter]
            amount=1
            animate=yes
            restore_statuses=no
        [/heal_unit]
    [/then]
[/if]

[/event]
[event]
name=defender hits
id=absorb_event2
first_time_only=no

[filter]
    ability=absorb
[/filter]
[filter_second]
[/filter_second]

[delay]
    time=10
[/delay]
[if]
    [variable]
        name=unit.hitpoints
        greater_than=0
    [/variable]
    [then]
        [heal_unit]
            [filter]
                ability=absorb
            [/filter]
            amount=1
            animate=yes
            restore_statuses=no
        [/heal_unit]
    [/then]
[/if]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_MEDICINE
[dummy]
    id=medicine
    name= _ "speed"
    description=_ "This unit gives adjacent units one additional movement point for a turn, at the begining of the units turn."
[/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
id=medicine_event1
name=turn refresh
first_time_only=no
[store_unit]
    [filter]
        [filter_adjacent]
            ability=medicine
            side=$side_number
        [/filter_adjacent]
        side=$side_number
    [/filter]
    variable=medicined
[/store_unit]
[foreach]
    array=medicined
    [do]
        {VARIABLE_OP medicined[$i].moves add 1}
        [unstore_unit]
            variable=medicined[$i]
            find_vacant=no
            text="+1 MP"
            red,green,blue=255,109,10
        [/unstore_unit]
    [/do]
[/foreach]
{CLEAR_VARIABLE medicined}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_EREWEGO
[leadership]
    id=erewego
    add=15
    name= _ "'ERE WE GO!"
    description=_"All adjacent friendly units will do 15% more damage in battle (this bonus stacks, 'ERE WE GO, 'ERE WE GO!)."
    affect_self=no
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
    [/affect_adjacent]
[/leadership]
#enddef

#define ABILITY_40K_CHRONOAURA2
[dummy]
    id=chronoaura2
    name= _ "glimpses of the future"
    description=_" All adjacent friendly units receive +10% chance to hit and all adjacent enemy units receive -10% chance to hit."
[/dummy]
[chance_to_hit]
    id=chronoaura2_debuff
    sub=10
    cumulative=yes
    affect_self=no
    affect_allies=no
    affect_enemies=yes
    [affect_adjacent]
        [filter]
        [/filter]
    [/affect_adjacent]
[/chance_to_hit]
[chance_to_hit]
    id=chronoaura2_buff
    add=10
    cumulative=yes
    affect_self=yes
    affect_allies=yes
    affect_enemies=no
    [affect_adjacent]
        [filter]
        [/filter]
    [/affect_adjacent]
[/chance_to_hit]	# wmlxgettext: [abilities]
[/abilities]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_SWARM
[damage]
    id=swarm
    name= _ "swarm tactic"
    description=_"When this unit is adjacent to another unit with swarm tactic, it increases its damage by one."
    add=1
    apply_to=self
    [filter_self]
        [filter_adjacent]
            is_enemy=no
            ability=swarm
        [/filter_adjacent]
    [/filter_self]
[/damage]
#enddef

#define ABILITY_40K_CHARGE_LEADERSHIP
[damage]
    id=charge_leadership
    name= _ "powder"
    description= _ "All nearby allies deal and take 20% more melee damage."
    [filter_student]
        [filter_weapon]
            range=melee
        [/filter_weapon]
    [/filter_student]
    active_on=offense
    multiply=1.2
    cumulative=no
    affect_self=no
    affect_allies=yes
    apply_to=both
    [affect_adjacent]
    [/affect_adjacent]
[/damage]
#enddef

#define ABILITY_40K_MOCKERY
[dummy]
    id=40k_mockery
    name= _ "mockery"
    description=_" When an attack against this unit misses, it heals 1 HP."
[/dummy]# wmlxgettext: [abilities]
[/abilities]
[event]
id=mockery_event1
name=attacker misses
first_time_only=no

[filter_second]
    ability=40k_mockery
[/filter_second]
[delay]
    time=10
[/delay]
[heal_unit]
    animate=yes
     [filter]
		x,y=$x2,$y2
     [/filter]
      amount=1
      restore_statuses=no
[/heal_unit]
[/event]
[event]
id=mockery_event2
name=defender misses
first_time_only=no
[filter]
     ability=40k_mockery
[/filter]
[delay]
    time=10
[/delay]
[heal_unit]
animate=yes
     [filter]
         x,y=$x1,$y1
     [/filter]
     amount=1
     restore_statuses=no
[/heal_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_FLEET_OF_FOOT
[dummy]
    id=40k_fleet_of_foot
    name= _ "fleet of foot"
    description=_ "If this unit runs out of moves with no adjacent enemy units, it loses its attack that turn but gains +1 MP."
[/dummy]# wmlxgettext: [abilities]
[/abilities]
[event]
id=fleet_of_foot_event
name=moveto
first_time_only=no
[filter]
    ability=40k_fleet_of_foot
    [not]
        [filter_adjacent]
            is_enemy=yes
        [/filter_adjacent]
    [/not]
[/filter]
[if]
    [variable]
        name=unit.moves
        equals=0
    [/variable]
    [and]
        [variable]
            name=unit.attacks_left
            greater_than=0
        [/variable]
    [/and]
    [then]
        {VARIABLE_OP unit.attacks_left sub 1}
        {VARIABLE_OP unit.moves add 1}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
    [/then]
[/if]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_SHADOWWALK
[hides]
    id=40k_shadowwalk
    name= _ "shadow walk"
    female_name= _ "shadow walk"
    description= _ "The unit becomes invisible when another allied unit is nearby, hiding in its shadow."
    affect_self=yes
    [filter_self]
        [filter_location]
            [filter]
                [not]
                    ability_type=hides
                [/not]
            [/filter]
            radius=1
        [/filter_location]
    [/filter_self]
[/hides]
#enddef

#define ABILITY_40K_BATTLE_FUELED
[dummy]
    id=battle_fueled
    name= _ "blood god's blessing"
    description=_ "When this unit initiates combat, it heals for 5 hitpoints."
[/dummy]# wmlxgettext: [abilities]
[/abilities]
[event]
id=battle_fueled_event
name=attack
first_time_only=no
[filter]
    ability=battle_fueled
[/filter]
[heal_unit]
    [filter]
        x,y=$x1,$y1
    [/filter]
    amount="5"
    restore_statuses=no
    animate=yes
[/heal_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_CHARM
[dummy]
    id=charm
    name= _ "charm"
    description=_ "This unit charms adjacent enemies at the beginning of its turn, making them unable to attack, but able to break this charm by fleeing."
[/dummy]# wmlxgettext: [abilities]
[/abilities]
[event]
id=charm_event
name=turn refresh
first_time_only=no
[store_unit]
    [filter]
        [filter_adjacent]
            [filter_side]
                [enemy_of]
                    side=$side_number
                [/enemy_of]
            [/filter_side]
            ability=charm
            is_enemy=yes
        [/filter_adjacent]
        [not]
            race=undead
        [/not]
        side=$side_number
    [/filter]
    kill=no
    variable=tempting_store_youll_want_to_be_there
[/store_unit]
[for]
    array=tempting_store_youll_want_to_be_there
    [do]
        {VARIABLE tempting_store_youll_want_to_be_there[$i].attacks_left 0}
        [unstore_unit]
            variable=tempting_store_youll_want_to_be_there[$i]
            find_vacant=no
            male_text=_"Charmed"
            female_text=_"female^Charmed"
			red,green,blue=255,0,255
        [/unstore_unit]
    [/do]
[/for]
{CLEAR_VARIABLE tempting_store_youll_want_to_be_there}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_40K_COLLECTIVE_REGENERATION
[regenerate]
    value=8
    id=collective_regeneration
    name= _ "collective regeneration"
    female_name= _ "female^collective regeneration"
    description= _ "The unit will heal itself 8 HP per turn if adjacent to another unit with the collective regeneration ability. If it is poisoned, it will remove the poison instead."
    affect_self=yes
    poison=cured
    [filter_self]
        [filter_adjacent]
            ability=collective_regeneration
        [/filter_adjacent]
    [/filter_self]
[/regenerate]
#enddef

#define ABILITY_40K_FERVOUR
[firststrike]
    id=fervour
    name= _ "fervour aura"
    female_name= _ "female^fervour aura"
    description= _ "All nearby allies get firststrike."
    affect_self=no
    affect_allies=yes
    [affect_adjacent]
    [/affect_adjacent]
[/firststrike]
#enddef

#define ABILITY_40K_SHIELDED
    [resistance]
        id=shielded
        name= _ "shielded"
        description= _ "This unit gets an extra 20% physical resistance when defending"
        add=20
        max_value=50
        apply_to=blade,pierce,impact
        [filter_base_value]
            less_than=50
        [/filter_base_value]
        affect_self=yes
        active_on=defense
    [/resistance]
#enddef

#define ABILITY_40K_PURITY_SEAL
[resistance]
    id=purity_seal
    add=10
    max_value=50
    apply_to=fire,cold,arcane
    name= _ "purity seal"
    description=_"Adjacent friendly units receive a +10% bonus to fire, cold and arcane resistances(up to a maximum of 50%)."
    affect_self=no
    affect_allies=yes
    [affect_adjacent]
        adjacent=n,ne,se,s,sw,nw
    [/affect_adjacent]
    [filter_base_value]
        less_than=50
    [/filter_base_value]
[/resistance]
#enddef