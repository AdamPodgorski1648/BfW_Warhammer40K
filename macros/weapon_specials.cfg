#define WEAPON_SPECIAL_40K_BLESSED_AIM
[chance_to_hit]
    id=blessed_aim
    name= _ "blessed aim"
    description= _ "When used offensively, this attack always has at least 70% chance to hit."
    value=70
    cumulative=yes
    active_on=offense
[/chance_to_hit]
#enddef

#define WEAPON_SPECIAL_ATTACK_ONLY
[disable]
    id=attack only
    name= _ "attack only"
    description= _ "This attack will only be used on offense."
    active_on=offense
[/disable]
#enddef

#define SMOTHER_DEFENSE VALUE
[effect]
    apply_to=defense
    replace=no
    [defense]
        deep_water={VALUE}
        shallow_water={VALUE}
        swamp_water={VALUE}
        reef={VALUE}
        flat={VALUE}
        sand={VALUE}
        forest={VALUE}
        hills={VALUE}
        mountains={VALUE}
        village={VALUE}
        castle={VALUE}
        cave={VALUE}
        frozen={VALUE}
        unwalkable={VALUE}
        fungus={VALUE}
    [/defense]
[/effect]
#enddef

#define WEAPON_SPECIAL_40K_SMOTHER
# wmlxgettext: [attack]
# wmlxgettext: [specials]

[dummy]
    id=smother
    name= _ "smother"
    description=_"When used offensively, units hit with this attack suffer a 20% reduction in terrain defenses and damage for 1 turn"
    active_on=offense
[/dummy]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
name=attacker hits
id=smother_event
first_time_only=no
[filter_second]
[not]
    ability=smothered
[/not]
[/filter_second]
[filter_attack]
special_id=smother
[/filter_attack]

[set_variables]
name=smother_unit_information
mode=append
[value]
    id=$second_unit.id
    side=$second_unit.side
    turn_of_unsmothered=$"($turn_number| + 1)"
[/value]
[/set_variables]
{MODIFY_UNIT id=$second_unit.id status.smothered yes}

[floating_text]
x,y=$x2,$y2
text="<span color='#ff0000'>" + _ "smothered" + "</span>"
[/floating_text]

[object]
silent=yes
[filter]
    find_in=second_unit
[/filter]
{SMOTHER_DEFENSE 20}
[effect]
	apply_to=image_mod
	replace="CS(50,0,0)"
[/effect]
[effect]
    apply_to=new_ability
    [abilities]
        [leadership]
            id=smothered
            value=-20
            cumulative=yes
            affect_self=yes
        [/leadership]
    [/abilities]
[/effect]
[/object]
[/event]
[event]
name=side turn
id=smother_event2
first_time_only=no

[foreach]
array=smother_unit_information
[do]
    [if]
        [variable]
            name=this_item.turn_of_mobilizing
            less_than_equal_to=$turn_number
        [/variable]
        [and]
            [variable]
                name=this_item.side
                equals=$side_number
            [/variable]
        [/and]
        
        [then]
            [object]
                silent=yes
                [filter]
                    find_in=this_item
                [/filter]
                {SMOTHER_DEFENSE -20}
				[effect]
					apply_to=image_mod
					replace="NOP()"
				[/effect]
                [effect]
                    apply_to=remove_ability
                    [abilities]
                        [leadership]
                            id=smothered
                            value=-20
                            cumulative=yes
                            affect_self=yes
                        [/leadership]
                    [/abilities]
                [/effect]
            [/object]
            {MODIFY_UNIT id=$this_item.id status.smothered no}
            
            [clear_variable]
                name=this_item
            [/clear_variable]
        [/then]
    [/if]
[/do]
[/foreach]
[/event]

[event]
name=victory
id=smother_event3
first_time_only=no

[foreach]
array=smother_unit_information
[do]
    [object]
        silent=yes
        [filter]
            find_in=this_item
        [/filter]
        {SMOTHER_DEFENSE -99}
		[effect]
			apply_to=image_mod
			replace="NOP()"
		[/effect]
        [effect]
            apply_to=remove_ability
            [abilities]
                [leadership]
                    id=smothered
                    value=-20
                    cumulative=yes
                    affect_self=yes
                [/leadership]
            [/abilities]
        [/effect]
    [/object]
    {MODIFY_UNIT id=$this_item.side.id status.smothered no}
    
    [clear_variable]
        name=this_item
    [/clear_variable]
[/do]
[/foreach]

{CLEAR_VARIABLE smother_unit_information}
[/event]
[+attack]
[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
#enddef


#define SUPPRESS_DEFENSE VALUE
[effect]
    apply_to=defense
    replace=no
    [defense]
        deep_water={VALUE}
        shallow_water={VALUE}
        swamp_water={VALUE}
        reef={VALUE}
        flat={VALUE}
        sand={VALUE}
        forest={VALUE}
        hills={VALUE}
        mountains={VALUE}
        village={VALUE}
        castle={VALUE}
        cave={VALUE}
        frozen={VALUE}
        unwalkable={VALUE}
        fungus={VALUE}
    [/defense]
[/effect]
#enddef

#define WEAPON_SPECIAL_40K_DAZZLE
# wmlxgettext: [attack]
# wmlxgettext: [specials]

[dummy]
    id=suppress
    name= _ "dazzle"
    description=_"When used offensively, units hit with this attack suffer a 30% reduction in damage for 1 turn"
    active_on=offense
[/dummy]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
name=attacker hits
id=suppress_event
first_time_only=no
[filter_second]
[not]
    ability=suppressed
[/not]
[/filter_second]
[filter_attack]
special_id=suppress
[/filter_attack]

[set_variables]
name=suppress_unit_information
mode=append
[value]
    id=$second_unit.id
    side=$second_unit.side
    turn_of_unsuppressed=$"($turn_number| + 1)"
[/value]
[/set_variables]
{MODIFY_UNIT id=$second_unit.id status.suppressed yes}

[floating_text]
x,y=$x2,$y2
text="<span color='#ffff00'>" + _ "dazzled" + "</span>"
[/floating_text]

[object]
silent=yes
[filter]
    find_in=second_unit
[/filter]
{SUPPRESS_DEFENSE 0}
[effect]
	apply_to=image_mod
	replace="CS(50,50,0)"
[/effect]
[effect]
    apply_to=new_ability
    [abilities]
        [leadership]
            id=suppressed
            value=-30
            cumulative=yes
            affect_self=yes
        [/leadership]
    [/abilities]
[/effect]
[/object]
[/event]
[event]
name=side turn
id=suppress_event2
first_time_only=no

[foreach]
array=suppress_unit_information
[do]
    [if]
        [variable]
            name=this_item.turn_of_mobilizing
            less_than_equal_to=$turn_number
        [/variable]
        [and]
            [variable]
                name=this_item.side
                equals=$side_number
            [/variable]
        [/and]
        
        [then]
            [object]
                silent=yes
                [filter]
                    find_in=this_item
                [/filter]
                {SUPPRESS_DEFENSE 0}
				[effect]
					apply_to=image_mod
					replace="NOP()"
				[/effect]
                [effect]
                    apply_to=remove_ability
                    [abilities]
                        [leadership]
                            id=suppressed
                            value=-30
                            cumulative=yes
                            affect_self=yes
                        [/leadership]
                    [/abilities]
                [/effect]
            [/object]
            {MODIFY_UNIT id=$this_item.id status.suppressed no}
            
            [clear_variable]
                name=this_item
            [/clear_variable]
        [/then]
    [/if]
[/do]
[/foreach]
[/event]

[event]
name=victory
id=suppress_event3
first_time_only=no

[foreach]
array=suppress_unit_information
[do]
    [object]
        silent=yes
        [filter]
            find_in=this_item
        [/filter]
        {SUPPRESS_DEFENSE 0}
		[effect]
			apply_to=image_mod
			replace="NOP()"
		[/effect]
        [effect]
            apply_to=remove_ability
            [abilities]
                [leadership]
                    id=suppressed
                    value=-30
                    cumulative=yes
                    affect_self=yes
                [/leadership]
            [/abilities]
        [/effect]
    [/object]
    {MODIFY_UNIT id=$this_item.side.id status.suppressed no}
    
    [clear_variable]
        name=this_item
    [/clear_variable]
[/do]
[/foreach]

{CLEAR_VARIABLE suppress_unit_information}
[/event]
[+attack]
[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
#enddef

#define WEAPON_SPECIAL_40K_EXPOSE
# wmlxgettext: [attack]
# wmlxgettext: [specials]

[dummy]
    id=expose
    name= _ "expose"
    description=_"When used offensively, units hit with this attack suffer a 20% reduction in terrain defenses for 1 turn"
    active_on=offense
[/dummy]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
name=attacker hits
id=expose_event
first_time_only=no
[filter_second]
[not]
    ability=exposed
[/not]
[/filter_second]
[filter_attack]
special_id=expose
[/filter_attack]

[set_variables]
name=expose_unit_information
mode=append
[value]
    id=$second_unit.id
    side=$second_unit.side
    turn_of_unexposed=$"($turn_number| + 1)"
[/value]
[/set_variables]
{MODIFY_UNIT id=$second_unit.id status.exposed yes}

[floating_text]
x,y=$x2,$y2
text="<span color='#ff0000'>" + _ "exposed" + "</span>"
[/floating_text]

[object]
silent=yes
[filter]
    find_in=second_unit
[/filter]
{SUPPRESS_DEFENSE 20}
[effect]
	apply_to=image_mod
	replace="CS(50,0,0)"
[/effect]
[effect]
    apply_to=new_ability
    [abilities]
        [dummy]
            id=exposed
            name= _ "exposed"
        [/dummy]
    [/abilities]
[/effect]
[/object]
[/event]
[event]
name=side turn
id=expose_event2
first_time_only=no

[foreach]
array=expose_unit_information
[do]
    [if]
        [variable]
            name=this_item.turn_of_mobilizing
            less_than_equal_to=$turn_number
        [/variable]
        [and]
            [variable]
                name=this_item.side
                equals=$side_number
            [/variable]
        [/and]
        
        [then]
            [object]
                silent=yes
                [filter]
                    find_in=this_item
                [/filter]
                {SUPPRESS_DEFENSE -20}
				[effect]
					apply_to=image_mod
					replace="NOP()"
				[/effect]
                [effect]
                    apply_to=remove_ability
                    [abilities]
                        [dummy]
                            id=exposed
                            name= _ "exposed"
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
            {MODIFY_UNIT id=$this_item.id status.exposed no}
            
            [clear_variable]
                name=this_item
            [/clear_variable]
        [/then]
    [/if]
[/do]
[/foreach]
[/event]

[event]
name=victory
id=expose_event3
first_time_only=no

[foreach]
array=expose_unit_information
[do]
    [object]
        silent=yes
        [filter]
            find_in=this_item
        [/filter]
        {SUPPRESS_DEFENSE -99}
		[effect]
			apply_to=image_mod
			replace="NOP()"
		[/effect]
        [effect]
            apply_to=remove_ability
            [abilities]
                [dummy]
                    id=exposed
                    name= _ "exposed"
                [/dummy]
            [/abilities]
        [/effect]
    [/object]
    {MODIFY_UNIT id=$this_item.side.id status.exposed no}
    
    [clear_variable]
        name=this_item
    [/clear_variable]
[/do]
[/foreach]

{CLEAR_VARIABLE expose_unit_information}
[/event]
[+attack]
[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
#enddef

#define WEAPON_SPECIAL_40K_RECKLESS
[damage]
    id=reckless
    name= _ "reckless"
    description= _ "When used offensively, this attack deals 40% more damage to the target. It also causes this unit to take 40% more damage from the targets counterattack."
    increase=40%
    apply_to=both
    active_on=offense
[/damage]
#enddef

#define WEAPON_SPECIAL_40K_PRECISION
[chance_to_hit]
    id=precision
    name= _ "precision"
    description=_"This attack always has at least 80% chance to hit"
    value=80
    cumulative=yes
[/chance_to_hit]
#enddef

#define WEAPON_SPECIAL_40K_SKILLED
[chance_to_hit]
    id=skilled
    name= _ "skilled"
    description= _ "When used offensively, this attack always has at least 50% chance to hit."
    value=50
    cumulative=yes
    active_on=offense
[/chance_to_hit]
#enddef

#define WEAPON_SPECIAL_MIND_FLAY
[mindflay]
    id=mind_flay
    name= _ "Mind Flay"
    description= _ "When used offensively, each hit of the mind flay attack takes 1 point of experience from the defender and gives it to the attacker."
    active_on=offense
[/mindflay]
[event]
    name=attack
    first_time_only=no
    [filter_attack]
        special_id=mind_flay
    [/filter_attack]
    {VARIABLE hit_number 0}
[/event]
[event]
    name=attacker_hits
    first_time_only=no
    [filter_attack]
        special_id=mind_flay
    [/filter_attack]
    {VARIABLE_OP hit_number add 1}
[/event]
[event]
    name=attack_end
    first_time_only=no
    [filter_attack]
        special_id=mind_flay
    [/filter_attack]
    {VARIABLE_OP second_unit.experience sub $hit_number}
    {VARIABLE_OP unit.experience add $hit_number}
    [unstore_unit]
        variable=unit
        text=$hit_number
        blue=255
    [/unstore_unit]
    [unstore_unit]
        variable=second_unit
    [/unstore_unit]
    {CLEAR_VARIABLE hit_number}
[/event]
#enddef

#define WEAPON_SPECIAL_40K_CONSUME VALUE
# wmlindent: start ignoring
# wmlxgettext: [attack]
# wmlxgettext: [specials]

# wmlindent: stop ignoring
[dummy]
    id=consume{VALUE}
    name= _ "consume"+" +"+"{VALUE}"
    description=_"When killing a living enemy while attacking, this unit is healed by "+""+"{VALUE}"
    active_on=offense
[/dummy]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
name=die
id=consume_event{VALUE}
first_time_only=no
[filter]
[not]
    [filter_wml]
        [status]
            not_living="yes"
        [/status]
    [/filter_wml]
[/not]
[/filter]

[filter_second_attack]
special_id=consume{VALUE}
[/filter_second_attack]

[heal_unit]
[filter]
    x,y=$x2,$y2
[/filter]
amount={VALUE}
animate=yes
restore_statuses=no
[/heal_unit]
[/event]

[+attack]
# wmlindent: start ignoring

[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
# wmlindent: stop ignoring
#enddef

#define WEAPON_SPECIAL_40K_AOE_SLOW
# wmlxgettext: [attack]
# wmlxgettext: [specials]
[dummy]
    id=aoe_slow
    name= _ "area of effect"
    active_on=offense
    description= _ "This attack can hit all adjacent enemy units. Works only on offense."
    [filter_opponent]
        [filter_weapon]
            [not]
                special_type=berserk
            [/not]
        [/filter_weapon]
    [/filter_opponent]
[/dummy]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring

[event]
name=attacker hits,attacker misses
first_time_only=no
id=aoe_event
[filter_attack]
special_id=aoe_slow
[/filter_attack]
[filter_second_attack]
[not]
    special_type=berserk
[/not]
[/filter_second_attack]

[store_unit]
[filter]
    [filter_adjacent]
        x,y=$x1,$y1
        is_enemy=yes
    [/filter_adjacent]
    [not]
        x,y=$x2,$y2
    [/not]
    [not]
        [filter_wml]
            [status]
                petrified=yes
            [/status]
        [/filter_wml]
    [/not]
[/filter]
variable=bystander
[/store_unit]

{VARIABLE areadmg $weapon.damage}

[if]
{VARIABLE_CONDITIONAL unit.status.slowed boolean_equals yes}
[then]
    {VARIABLE_OP areadmg divide 2}
    {VARIABLE_OP areadmg round floor}
[/then]
[/if]

[foreach]
array=bystander
[do]
    {RANDOM 1..100}
    [if]
        {VARIABLE_CONDITIONAL random less_than_equal_to 70}
        [then]
            [harm_unit]
                [filter]
                    x,y=$this_item.x,$this_item.y
                    [not]
                        [filter_wml]
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/filter]
                [filter_second]
                    x,y=$x1,$y1
                [/filter_second]
                amount=$areadmg
                damage_type=$weapon.type
                alignment=$unit.alignment
                slowed=yes
                fire_event=yes
                animate=defender
                delay=0
                experience=no
            [/harm_unit]
        [/then]
    [/if]
[/do]
[/foreach]
{CLEAR_VARIABLE bystander}
[/event]
[+attack]
# wmlindent: start ignoring

[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
# wmlindent: stop ignoring
#enddef

#define WEAPON_SPECIAL_40K_COUNTER
[chance_to_hit]
    id=counter
    name= _ "try me"
    description=_"The unit has at least 70% chance to hit during retaliation."
    value=70
    cumulative=yes
    active_on=defense
    apply_to=self
[/chance_to_hit]
#enddef

#define WEAPON_SPECIAL_40K_WAGH
[damage]
    name= _ "WAAAGH! psychic energy"
    description=_"When this unit is adjacent to another allied Ork, the damage of this attack is increased by 3."
    id=wagh
    add=3
    apply_to=self
    [filter_self]
        [filter_adjacent]
            is_enemy=no
            [filter]
                race=Orks
            [/filter]
        [/filter_adjacent]
    [/filter_self]
[/damage]
#enddef

#define WEAPON_SPECIAL_40K_DISTRACT
# wmlxgettext: [attack]
# wmlxgettext: [specials]
[dummy]
    id=distract
    name= _ "distract"
    description= _ "This attack distracts the enemy, disrupting its ZOC for the rest of the turn if a hit is landed. Not active on defense."
    apply_to=opponent
    active_on=offense
[/dummy]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring

[event]
name=attacker_hits
id=distract_event1
first_time_only=no
[filter_attack]
special_id=distract
[/filter_attack]
[filter_second]
[not]
    [filter_wml]
        zoc=no
    [/filter_wml]
[/not]
[/filter_second]

[if]
[variable]
    name=second_unit.variables.stunned
    boolean_equals=no
[/variable]
[then]
    {VARIABLE second_unit.variables.stunned yes}
    
    [unstore_unit]
        variable=second_unit
        find_vacant=no
        text=_ "distracted"
        red,green,blue=255,0,255
    [/unstore_unit]
    
    [object]
        silent=yes
        duration=scenario
        
        [filter]
            x,y=$x2,$y2
        [/filter]
        
        [effect]
            apply_to=image_mod
            replace="CS(50,0,50)"
        [/effect]
        
        [effect]
            apply_to=zoc
            value=no
        [/effect]
    [/object]
[/then]
[/if]
[/event]

[event]
name=turn refresh
id=distract_event2
first_time_only=no

[store_unit]
[filter]
    side=$side_number
    [filter_wml]
        [variables]
            stunned=yes
        [/variables]
    [/filter_wml]
[/filter]
variable=stunned
[/store_unit]

[foreach]
array=stunned
[do]
    {VARIABLE this_item.variables.stunned no}
    
    [unstore_unit]
        variable=this_item
    [/unstore_unit]
    
    [object]
        silent=yes
        duration=scenario
        
        [filter]
            x,y=$this_item.x,$this_item.y
        [/filter]
        
        [effect]
            apply_to=image_mod
            replace="NOP()"
        [/effect]
        
        [effect]
            apply_to=zoc
            value=yes
        [/effect]
    [/object]
[/do]
[/foreach]

{CLEAR_VARIABLE stunned}
[/event]
[+attack]
[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
#enddef

#define WEAPON_SPECIAL_40K_OVERPOWER
# wmlxgettext: [attack]
# wmlxgettext: [specials]
[dummy]
    id=overpower
    name= _ "overpower"
    description= _ "This attack overpowers the enemy, reducing its chance to hit by 20% for the rest of the turn if a hit is landed. Not active on defense."
    apply_to=opponent
    active_on=offense
[/dummy]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
name=attacker_hits
id=overpower_event1
first_time_only=no
[filter_attack]
special_id=overpower
[/filter_attack]

[if]
[variable]
    name=second_unit.variables.overpowered
    boolean_equals=no
[/variable]
[then]
    {VARIABLE second_unit.variables.overpowered yes}
    
    [unstore_unit]
        variable=second_unit
        find_vacant=no
        text= _ "overwhelmed"
        red,green,blue=255,0,0
    [/unstore_unit]
    
    [object]
        silent=yes
        duration=scenario
        
        [filter]
            x,y=$x2,$y2
        [/filter]
        
        [effect]
            apply_to=image_mod
            replace="CS(50,0,0)"
        [/effect]
        [effect]
            apply_to=attack
            [set_specials]
            mode=append
                [chance_to_hit]
                    id=overpowered
                    sub=20
					cumulative=yes
					affect_self=yes
                [/chance_to_hit]
            [/set_specials]
        [/effect]
    [/object]
[/then]
[/if]
[/event]

[event]
name=turn refresh
id=overpower_event2
first_time_only=no

[store_unit]
[filter]
    side=$side_number
    [filter_wml]
        [variables]
            overpowered=yes
        [/variables]
    [/filter_wml]
[/filter]
variable=overpowered
[/store_unit]

[foreach]
array=overpowered
[do]
    {VARIABLE this_item.variables.overpowered no}
    
    [unstore_unit]
        variable=this_item
    [/unstore_unit]
    
    [object]
        silent=yes
        duration=scenario
        
        [filter]
            x,y=$this_item.x,$this_item.y
        [/filter]
        
        [effect]
            apply_to=image_mod
            replace="NOP()"
        [/effect]       
        [effect]
            apply_to=attack
            remove_specials=overpowered
        [/effect]
    [/object]
[/do]
[/foreach]

{CLEAR_VARIABLE overpowered}
[/event]
[+attack]
[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
#enddef